<!DOCTYPE html>

<html lang="&{play.i18n.Lang.get()}">
<head>
    <title>${play.i18n.Messages.get('views.application.schedule.title')}</title>

    <!-- Bootstrap -->
    <!-- Bootstrap has been customized to modify a variable :
         Point at which the navbar becomes uncollapsed => @grid-float-breakpoint = @screen-md-min
         (http://getbootstrap.com/customize/)
    -->
    <link rel="stylesheet" href="@{'/public/bootstrap/3.3.7/css/bootstrap.min.css'}" >
    <link rel="stylesheet" href="@{'/public/bootstrap/3.3.7/css/bootstrap-theme.min.css'}" >

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,600|Raleway:400,600|Righteous&amp;subset=latin-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">

    <!-- Font awesome -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Custom -->
    <link rel="stylesheet" href="@{'/public/stylesheets/slides.css'}">

    #{get 'moreStyles' /}
</head>
<body>

    <div class="container-fluid">

    <h2 class="schedule-day fullSchedule-day schedule-day1">${track}</h2>

    <div id="target"></div>

    <ul>
        <li><a href="@{Application.slides("Keynotes")}">Keynotes [Amphi 339]</a></li>
        #{list tracks, as: 'trackItem'}
            <li><a href="@{Application.slides(trackItem.title)}">${trackItem.title}</a></li>
        #{/list}
    </ul>

    </div> <!-- /.container -->

    <!-- External libs -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <!-- Custom JS -->
    <script>
        // var now = new Date();
        var now = Date.parse("Thu, 11 May 2017 09:21:00 +0200");
        var showTrack = "${track}";
        var tracks = {
        "Keynotes [Amphi 339]": [
        #{list keynotes, as: 'talk'}
        {
            "title": "${talk.getTitle().jsonEscape()}",
            "description": "${talk.getDescription().jsonEscape()}", 
            "start": ${talk.slot.startDate.time}, 
            "end": ${talk.slot.endDate.time},
            "track": "Keynotes",
            "speakers": [
            #{list talk.speakers, as: 'speaker'}
            {
                "name": "${speaker.firstName.jsonEscape()} ${speaker.lastName.jsonEscape()}",
                "photo": "@{Application.speakerPhoto(speaker.id)}"
            }#{if !speaker_isLast},#{/if}
            #{/list}
            ]
        }#{if !talk_isLast},#{/if}
        #{/list}
        ], 
        #{list tracks, as: 'track'}
        "${track.title}": [
        #{list track.talks, as: 'talk'}
            {
            "title": "${talk.getTitle().jsonEscape()}",
            "description": "${talk.getDescription().jsonEscape()}", 
            "start": ${talk.slot.startDate.time}, 
            "end": ${talk.slot.endDate.time},
            "track": "${track.title.jsonEscape()}", 
            "speakers": [
            #{list talk.speakers, as: 'speaker'}
            {
                "name": "${speaker.firstName.jsonEscape()} ${speaker.lastName.jsonEscape()}",
                "photo": "@{Application.speakerPhoto(speaker.id)}"
            }#{if !speaker_isLast},#{/if}
            #{/list}
            ]
            }#{if !talk_isLast},#{/if}
        #{/list}
        ]#{if !track_isLast},#{/if} 
        #{/list}
        };

        function showTalks(){
            var current = null;
            var currentOtherTracks = [];
            var next = null;
            var nextOtherTracks = [];
            for(var t in tracks){
                var track = tracks[t];
                for(var i=0;i<track.length;i++){
                    var talk = track[i];
                    if(talk.start <= now && talk.end >= now){
                        if(talk.track == showTrack){
                            current = talk;
                        }else{
                            currentOtherTracks.push(talk);
                        }
                    }else if(talk.start > now){
                        if(talk.track == showTrack){
                            if(next == null || next.start > talk.start){
                                next = talk;
                            }
                        }else{
                            var addIt = true;
                            for(var n=0;n<nextOtherTracks.length;n++){
                                if(nextOtherTracks[n].track == talk.track){
                                    if(nextOtherTracks[n].start > talk.start){
                                        console.log("remove");
                                        nextOtherTracks.splice(n, 1);
                                    }else{
                                        addIt = false;
                                    }
                                    break;
                                }
                            }
                            if(addIt)
                                nextOtherTracks.push(talk);
                        }
                    }
                }
            }
            var t = jQuery("#target");
            t.empty();
            var markup = "<div class='row'>";
            markup += "<div class='current col-md-6'>";
            markup += talkToString(current);
            markup += "</div>";
            if(next){
                markup += "Coming next in this track:";
                markup += "<div class='next col-md-6'>";
                markup += talkToString(next);
                markup += "</div>";
            }
            markup += "</div>";
            t.append(markup);
            if(currentOtherTracks.length > 0){
                t.append("Currently in other tracks:");
                var co = jQuery("<div class='current-other'/>").appendTo(t);
                for(var n=0;n<currentOtherTracks.length;n++){
                    var talk = currentOtherTracks[n];
                    co.append(talkToString(talk));
                }
            }
            if(nextOtherTracks.length > 0){
                t.append("Next in other tracks:");
                var no = jQuery("<div class='next-other'/>").appendTo(t);
                var markup = "<div class='row'>";
                for(var n=0;n<nextOtherTracks.length;n++){
                    markup += "<div class='col-md-3'>";
                    var talk = nextOtherTracks[n];
                    markup += "<h2 class='schedule-day fullSchedule-day schedule-day2'>"+talk.track+"</h2>";
                    markup += talkToString(talk);
                    markup += "</div>";
                }
                markup += "</div>";
                no.append(markup);
            }
        }
        var months = [
        "Janvier",
        "Février",
        "Mars",
        "Avril",
        "Mai",
        "Juin",
        "Juillet",
        "Août",
        "Septembre",
        "Octobre",
        "Novembre",
        "Decembre",
        ];
        function formatDate(date){
            return pad(date.getDay()) + " " + months[date.getMonth()];
        }
        function formatTime(date){
            return pad(date.getHours()) + ":" + pad(date.getMinutes());
        }
        function pad(num) {
            var s = num+"";
            while (s.length < 2) s = "0" + s;
            return s;
        }
        function duration(time){
            console.log(time);
            var seconds = Math.floor(time / 1000);
            var minutes = Math.floor(seconds / 60);
            var secondsMod = seconds % 60;
            var hours = Math.floor(minutes / 60);
            var minutesMod = minutes % 60;
            var days = Math.floor(hours / 24);
            var hoursMod = hours % 24;
            var weeks = Math.floor(days / 7);
            var daysMod = days % 7;
            
            var ret="";
            if(weeks > 0)
                ret += weeks+" weeks ";
            if(daysMod > 0)
                ret += daysMod+" days ";
            if(hoursMod > 0)
                ret += hoursMod+" hours ";
            if(minutesMod > 0)
                ret += minutesMod+" minutes ";
            if(secondsMod > 0)
                ret += secondsMod+" seconds";
            return ret;
        }

        function talkToString(talk){
            if(talk == null)
                return "";
            var start = new Date(talk.start);
            var end = new Date(talk.end);
            var durationString;
            if(start.getTime() > now){
                durationString = " (in " + duration(start.getTime() - now)+")";
            }else{
                durationString = " (" + duration(end.getTime() - now)+" remaining)";
            }
            var markup = "<div class='talk'>" +
                    "<div class='date'>"+formatDate(start)+" "+
                    formatTime(start)+" - "+
                    formatTime(end)+durationString+"</div>";
            markup += "<div class='talkDetails-title'>"+talk.title+"</div>";
            //markup += "<div class='description'>"+talk.description+"</div>";
            for(var n=0;n<talk.speakers.length;n++){
                var speaker = talk.speakers[n];
                markup += "<figure class='personSummary'>";
                    markup += "<div class='personSummary-photo' style='background-image: url(" + speaker.photo + ")'></div>";
                    markup += "<figcaption class='personSummary-desc'>";
                        markup += "<div class='personSummary-name'>"+speaker.name+"</div>";
                    markup += "</figcaption>";
                markup += "</figure>";
            }
            markup += "</div>";
            return markup;
        }
        jQuery(function(){
            showTalks();
        });

    </script>

</body>
</html>
